## Downward API with Environment Variables
##
## Tests the Downward API functionality by exposing pod metadata through:
##  * Environment variables using supported fieldRef paths
##  * Integration with ConfigMaps and Secrets
## 
## This validates that the virtual kubelet properly implements the Downward API
## fieldRef environment variable injection.


apiVersion: v1
kind: Pod
metadata:
  name: downward-api-test-{{ uuid }}
  namespace: {{ namespace }}
  annotations: {{ annotations | tojson }}
  labels:
    app: downward-api-test
    version: "1.0"
    test-id: "{{ uuid }}"

spec:
  restartPolicy: Never
  nodeSelector:
    kubernetes.io/hostname: {{ target_node }}

  containers:
  - name: downward-api-container
    image: python:alpine
    command: ["python", "-c"]
    args:
      - |
        import os
        import time
        
        print("=== Downward API Environment Variables ===")
        env_vars = [
          'POD_NAME', 'POD_NAMESPACE', 'POD_UID', 'NODE_NAME', 
          'SERVICE_ACCOUNT', 'POD_IP', 'HOST_IP'
        ]
        
        for var in env_vars:
            value = os.environ.get(var, 'NOT_SET')
            print(f"{var}: {value}")
        
        print("=== Test completed ===")

    env:
      # Environment variables from Downward API fieldRef
      - name: POD_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.name
      - name: POD_NAMESPACE
        valueFrom:
          fieldRef:
            fieldPath: metadata.namespace
      - name: POD_UID
        valueFrom:
          fieldRef:
            fieldPath: metadata.uid
      - name: NODE_NAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
      - name: SERVICE_ACCOUNT
        valueFrom:
          fieldRef:
            fieldPath: spec.serviceAccountName
      - name: POD_IP
        valueFrom:
          fieldRef:
            fieldPath: status.podIP
      - name: HOST_IP
        valueFrom:
          fieldRef:
            fieldPath: status.hostIP


    imagePullPolicy: Always
    
    
  dnsPolicy: ClusterFirst
  tolerations: {{ tolerations | tojson }}

################################################################################
# VALIDATION
timeout_seconds: 15
check_pods: 
  - name: downward-api-test-{{ uuid }}
    namespace: {{ namespace }}

check_logs: 
  # Verify Downward API fieldRef environment variables
  - name: downward-api-test-{{ uuid }}
    namespace: {{ namespace }}
    regex: "POD_NAME: downward-api-test-{{ uuid }}"
    operator: Exists

  - name: downward-api-test-{{ uuid }}
    namespace: {{ namespace }}
    regex: "POD_NAMESPACE: {{ namespace }}"
    operator: Exists

  - name: downward-api-test-{{ uuid }}
    namespace: {{ namespace }}
    regex: "NODE_NAME: {{ target_node }}"
    operator: Exists

  - name: downward-api-test-{{ uuid }}
    namespace: {{ namespace }}
    regex: "POD_UID: [a-f0-9-]+"
    operator: Exists

  # Verify test completion
  - name: downward-api-test-{{ uuid }}
    namespace: {{ namespace }}
    regex: "Test completed"
    operator: Exists

clean_configs:
  - type: pod
    name: downward-api-test-{{ uuid }}
    namespace: {{ namespace }}
    condition: onSuccess

